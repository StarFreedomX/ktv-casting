name: Cross-Platform Build & Release

permissions:
  contents: write

on:
  push:
    # å…è®¸ main å’Œ TUI åˆ†æ”¯çš„ push è§¦å‘æµ‹è¯•æ„å»º
    branches: [ "main", "TUI" ]
    # ç›‘å¬ä¸¤ç§ tag æ ¼å¼ï¼š
    # 1. v1.0.0 (ä¸»çº¿)
    # 2. tui-v0.1.0 (TUIåˆ†æ”¯)
    tags: [ "v*", "tui-v*" ]
  pull_request:
    branches: [ "main", "TUI" ]

env:
  CARGO_TERM_COLOR: always
  # è¿™æ˜¯ Cargo.toml é‡Œå†™çš„åŸå§‹åå­— (ç¼–è¯‘äº§å‡ºçš„åå­—)
  CRATE_NAME: ktv-casting

jobs:
  build-and-upload:
    name: Build - ${{ matrix.platform.release_for }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # 1. Android ARM64
          - release_for: Android-aarch64
            os: ubuntu-latest
            # ä¿®æ”¹ target ä¸º android
            target: aarch64-linux-android
            command: cross
            # Android é»˜è®¤å¼€å¯ PIEï¼Œé€šå¸¸ç•™ç©ºå³å¯ï¼›å¦‚æœæŠ¥é”™å†å°è¯•åŠ ä¸Š
            rustflags: ""

          # 2. Linux x64 (Musl)
          - release_for: Linux-x86_64-musl
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            command: cross
            rustflags: ""

          # 3. Windows x64 (MSVC) - ä¸éœ€è¦ PIE flags
          - release_for: Windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            command: cargo
            rustflags: ""

          # 4. macOS ARM64 - ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼Œé»˜è®¤å³å¯
          - release_for: macOS-aarch64
            os: macos-14
            target: aarch64-apple-darwin
            command: cargo
            rustflags: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸŒŸ æ–°å¢æ­¥éª¤ï¼šæ ¹æ® Tag å†³å®šå‘å¸ƒæ—¶çš„æ–‡ä»¶åå’Œæ˜¯å¦ä¸ºé¢„è§ˆç‰ˆ
      - name: Determine Release Config
        shell: bash
        run: |
          # é»˜è®¤é…ç½® (Master/Main)
          FINAL_NAME="${{ env.CRATE_NAME }}"
          IS_PRERELEASE="false"

          # æ£€æŸ¥å½“å‰ Tag æ˜¯å¦ä»¥ 'tui-' å¼€å¤´
          if [[ "${{ github.ref }}" == *"refs/tags/tui-"* ]]; then
            echo "Detecting TUI release..."
            # ç»™å‘å¸ƒçš„æ–‡ä»¶ååŠ ä¸ª -tui åç¼€ï¼Œå˜æˆ ktv-casting-tui
            FINAL_NAME="${{ env.CRATE_NAME }}-tui"
            # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼ŒGitHub UI ä¸Šä¼šæ˜¾ç¤ºä¸º "Pre-release"
            IS_PRERELEASE="true"
          fi

          # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "FINAL_BIN_NAME=$FINAL_NAME" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_ENV
          
          echo "Build Mode: Name=$FINAL_NAME, Prerelease=$IS_PRERELEASE"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: "${{ matrix.platform.target }}"

      - name: Install Cross
        if: matrix.platform.command == 'cross'
        shell: bash
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Build Binary
        shell: bash
        run: |
          export RUSTFLAGS="${{ matrix.platform.rustflags }}"
          if [ "${{ matrix.platform.command }}" == "cross" ]; then
            cross build --release --target ${{ matrix.platform.target }}
          else
            cargo build --release --target ${{ matrix.platform.target }}
          fi

      - name: Rename and Move Binary
        shell: bash
        run: |
          mkdir -p dist
          
          # å¤„ç† Windows åç¼€
          if [ "${{ matrix.platform.os }}" == "windows-latest" ]; then
            EXT=".exe"
          else
            EXT=""
          fi
          
          # SRC: ä½¿ç”¨ Cargo.toml é‡Œçš„åŸå§‹åå­— (CRATE_NAME)
          SRC="target/${{ matrix.platform.target }}/release/${{ env.CRATE_NAME }}$EXT"
          
          # DST: ä½¿ç”¨æˆ‘ä»¬è¦å‘å¸ƒçš„æœ€ç»ˆåå­— (FINAL_BIN_NAMEï¼Œå¯èƒ½åŒ…å« -tui)
          DST="dist/${{ env.FINAL_BIN_NAME }}-${{ matrix.platform.target }}$EXT"
          
          echo "Moving $SRC to $DST"
          cp "$SRC" "$DST"

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*
          generate_release_notes: true
          # ğŸŒŸ æ ¹æ®å‰é¢çš„åˆ¤æ–­ï¼ŒåŠ¨æ€è®¾ç½®æ˜¯å¦ä¸º Pre-release
          prerelease: ${{ env.IS_PRERELEASE }}